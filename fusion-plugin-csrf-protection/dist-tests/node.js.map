{"version":3,"file":"node.js","sources":["../src/shared.js","../src/server.js","../src/browser.js","../src/index.js","../src/__tests__/interface.js","../src/__tests__/test.node.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from 'fusion-core';\nimport type {Token} from 'fusion-core';\n\nconst methods = {POST: 1, PUT: 1, PATCH: 1, DELETE: 1};\n\nexport function verifyMethod(\n  method: string | $Keys<typeof methods>\n): $Values<typeof methods> {\n  return methods[method];\n}\nexport const CsrfIgnoreRoutesToken: Token<Array<string>> = createToken(\n  'CsrfIgnoreRoutesToken'\n);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createPlugin, type FusionPlugin} from 'fusion-core';\nimport type {Fetch} from 'fusion-tokens';\n\nimport {verifyMethod, CsrfIgnoreRoutesToken} from './shared';\n\ntype PluginDepsType = {\n  ignored: typeof CsrfIgnoreRoutesToken.optional,\n};\n\ntype ServiceType = () => Promise<void>;\n\nconst enhancer = (\n  oldFetch: Fetch\n): FusionPlugin<PluginDepsType, ServiceType> => {\n  return createPlugin({\n    deps: {\n      ignored: CsrfIgnoreRoutesToken.optional,\n    },\n    provides: deps => {\n      return function serverFetch() {\n        return Promise.reject(new Error('Cannot use fetch on the server'));\n      };\n    },\n    middleware: deps => {\n      const {ignored = []} = deps;\n      const ignoreSet = new Set(ignored);\n\n      return async function csrfMiddleware(ctx, next) {\n        if (ctx.path === '/csrf-token' && ctx.method === 'POST') {\n          // TODO(#158): Remove this once clients have had the opportunity to upgrade\n          ctx.set('x-csrf-token', 'x');\n          ctx.status = 200;\n          ctx.body = '';\n        } else if (verifyMethod(ctx.method) && !ignoreSet.has(ctx.path)) {\n          const token = ctx.headers['x-csrf-token'];\n          if (!token) {\n            const message =\n              `Missing csrf token on ${ctx.path}` +\n              (__DEV__\n                ? ' Ensure you are using `fetch` from `fusion-plugin-csrf-protection-[react].'\n                : '');\n            ctx.throw(403, message);\n          }\n        }\n        return next();\n      };\n    },\n  });\n};\n\nexport default enhancer;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\nimport type {Fetch} from 'fusion-tokens';\nimport {verifyMethod} from './shared';\n\nconst enhancer = (fetch: Fetch) => {\n  const prefix = window.__ROUTE_PREFIX__ || ''; // created by fusion-core/src/server\n  let fetchWithCsrfToken: Fetch = (url, options) => {\n    if (!options) options = {};\n    const isCsrfMethod = verifyMethod(options.method || 'GET');\n    if (!isCsrfMethod) {\n      return fetch(url, options);\n    }\n    return fetch(prefix + String(url), {\n      ...options,\n      credentials: 'same-origin',\n      headers: {\n        ...((options && options.headers) || {}),\n        'x-csrf-token': 'x',\n      },\n    });\n  };\n  return fetchWithCsrfToken;\n};\n\nexport default enhancer;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport serverCsrf from './server.js';\nimport clientCsrf from './browser.js';\n\ndeclare var __NODE__: Boolean;\nexport default (__NODE__ ? serverCsrf : clientCsrf);\n\nexport {CsrfIgnoreRoutesToken} from './shared';\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport tape from 'tape-cup';\n\nimport Plugin, {CsrfIgnoreRoutesToken} from '../index';\n\ntape('plugin api', t => {\n  t.ok(Plugin);\n  t.ok(CsrfIgnoreRoutesToken);\n  t.end();\n});\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env node */\nimport test from 'tape-cup';\n\nimport App, {createPlugin} from 'fusion-core';\nimport {FetchToken} from 'fusion-tokens';\nimport {getSimulator} from 'fusion-test-utils';\n\nimport CsrfPlugin from '../server';\nimport {CsrfIgnoreRoutesToken} from '../shared';\n\nfunction MockFetch() {\n  return Promise.resolve();\n}\n\nfunction getApp() {\n  const app = new App('fake-element', el => el);\n  app.middleware(async (ctx, next) => {\n    try {\n      await next();\n    } catch (e) {\n      ctx.status = e.status || 500;\n      ctx.body = e.message;\n    }\n  });\n  // $FlowFixMe\n  app.register(FetchToken, MockFetch);\n  app.enhance(FetchToken, CsrfPlugin);\n  return app;\n}\n\ntest('valid token', async t => {\n  const app = getApp();\n  app.middleware((ctx, next) => {\n    if (ctx.url === '/test' && ctx.method === 'POST') {\n      ctx.status = 200;\n      ctx.body = 'test';\n    }\n    return next();\n  });\n  const sim = getSimulator(app);\n  const ctx = await sim.request('/test', {\n    method: 'POST',\n    headers: {\n      'x-csrf-token': 'x',\n    },\n  });\n  t.equal(ctx.status, 200);\n  t.equal(ctx.body, 'test');\n  t.end();\n});\n\ntest('GET request', async t => {\n  const app = getApp();\n  app.middleware((ctx, next) => {\n    if (ctx.url === '/test' && ctx.method === 'GET') {\n      ctx.status = 200;\n      ctx.body = 'test';\n    }\n    return next();\n  });\n  const sim = getSimulator(app);\n  const ctx = await sim.request('/test');\n  t.equal(ctx.status, 200);\n  t.equal(ctx.body, 'test');\n  t.end();\n});\n\ntest('/csrf-token POST', async t => {\n  const app = getApp();\n  const sim = getSimulator(app);\n  const ctx = await sim.request('/csrf-token', {\n    method: 'POST',\n  });\n  t.equal(ctx.status, 200);\n  t.end();\n});\n\ntest('POST with missing token', async t => {\n  const app = getApp();\n  app.middleware((ctx, next) => {\n    if (ctx.url === '/test' && ctx.method === 'POST') {\n      ctx.status = 200;\n      ctx.body = 'test';\n    }\n    return next();\n  });\n  const sim = getSimulator(app);\n  const ctx = await sim.request('/test', {\n    method: 'POST',\n  });\n  t.equal(ctx.status, 403);\n  t.end();\n});\n\ntest('does not verify ignored paths', async t => {\n  const app = getApp();\n  app.register(CsrfIgnoreRoutesToken, ['/test']);\n  app.middleware((ctx, next) => {\n    if (ctx.path === '/test') ctx.body = {ok: 1};\n    return next();\n  });\n  const simulator = getSimulator(app);\n  const ctx = await simulator.request('/test', {\n    method: 'POST',\n  });\n  t.equal(ctx.status, 200);\n  t.end();\n});\n\ntest('throws if fetch is used on server', async t => {\n  const app = getApp();\n  app.register(\n    createPlugin({\n      deps: {fetch: FetchToken},\n      provides: ({fetch}) => {\n        fetch('/test').catch(e => {\n          t.ok(e, 'throws on server');\n          t.end();\n        });\n      },\n    })\n  );\n  getSimulator(app);\n});\n"],"names":["methods","POST","PUT","PATCH","DELETE","verifyMethod","method","CsrfIgnoreRoutesToken","createToken","enhancer","oldFetch","createPlugin","deps","ignored","optional","provides","serverFetch","Promise","reject","Error","middleware","ignoreSet","Set","csrfMiddleware","ctx","next","path","set","status","body","has","token","headers","message","throw","serverCsrf","tape","t","ok","Plugin","end","MockFetch","resolve","getApp","app","App","el","e","register","FetchToken","enhance","CsrfPlugin","test","url","sim","getSimulator","request","equal","simulator","fetch","catch"],"mappings":"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"}
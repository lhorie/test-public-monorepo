{"version":3,"file":"node.js","sources":["../src/server.js","../src/browser.js","../src/index.js","../src/__tests__/render.js","../src/__tests__/request.node.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport React from 'react';\nimport {createPlugin, dangerouslySetHTML} from 'fusion-core';\nimport {HelmetProvider} from 'react-helmet-async';\n\nimport type {FusionPlugin} from 'fusion-core';\n\nconst keys = ['meta', 'link', 'style', 'base', 'noscript', 'script'];\n\nconst plugin =\n  __NODE__ &&\n  createPlugin({\n    middleware: () => {\n      return async (ctx, next) => {\n        if (!ctx.element) {\n          return next();\n        }\n        const helmetContext = {};\n        ctx.element = (\n          <HelmetProvider context={helmetContext}>{ctx.element}</HelmetProvider>\n        );\n        await next();\n        const {helmet} = helmetContext;\n        if (helmet) {\n          ctx.template.title = helmet.title\n            .toString()\n            .replace('</title>', '')\n            .replace(/^<title.*>/, '');\n          keys.forEach(key => {\n            ctx.template.head.push(dangerouslySetHTML(helmet[key].toString()));\n          });\n        }\n      };\n    },\n  });\n\nexport default ((plugin: any): FusionPlugin<void, void>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport React from 'react';\nimport {createPlugin} from 'fusion-core';\nimport {HelmetProvider} from 'react-helmet-async';\n\nimport type {FusionPlugin} from 'fusion-core';\n\nconst plugin =\n  __BROWSER__ &&\n  createPlugin({\n    middleware: () => {\n      return (ctx, next) => {\n        ctx.element = (\n          <HelmetProvider context={{}}>{ctx.element}</HelmetProvider>\n        );\n        return next();\n      };\n    },\n  });\n\nexport default ((plugin: any): FusionPlugin<void, void>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport Helmet from 'react-helmet-async';\nimport serverPlugin from './server';\nimport clientPlugin from './browser';\n\ndeclare var __NODE__: Boolean;\nexport default (__NODE__ ? serverPlugin : clientPlugin);\nexport {Helmet};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport App from 'fusion-react';\nimport {render} from 'react-dom';\nimport fs from 'fs';\nimport React from 'react';\nimport {getSimulator} from 'fusion-test-utils';\nimport Helmet from 'react-helmet-async';\nimport test from 'tape-cup';\nimport HelmetPlugin from '../index.js';\n\nconst name = __NODE__ ? 'Server' : 'Client';\ntest(`${name} side render`, async t => {\n  const TestA = () => {\n    return (\n      <div>\n        <Helmet defaultTitle=\"My Default Title\">\n          <html lang=\"en\" amp />\n          <body className=\"root\" />\n          <title itemProp=\"name\" lang=\"en\">\n            My Title\n          </title>\n          <base target=\"_blank\" href=\"http://mysite.com/\" />\n          <meta name=\"description\" content=\"Helmet application\" />\n          <meta property=\"og:type\" content=\"article\" />\n          <link rel=\"canonical\" href=\"http://mysite.com/example\" />\n          <link\n            rel=\"apple-touch-icon\"\n            href=\"http://mysite.com/img/apple-touch-icon-57x57.png\"\n          />\n          <script src=\"http://include.com/pathtojs.js\" type=\"text/javascript\" />\n          <script type=\"application/ld+json\">{`\n        {\n            \"@context\": \"http://schema.org\"\n        }\n    `}</script>\n          <noscript>{`\n        <link rel=\"stylesheet\" type=\"text/css\" href=\"foo.css\" />\n    `}</noscript>\n\n          <style type=\"text/css\">{`\n        body {\n            background-color: blue;\n        }\n\n        p {\n            font-size: 12px;\n        }\n    `}</style>\n        </Helmet>\n      </div>\n    );\n  };\n\n  const Root = (\n    <div>\n      <TestA />\n    </div>\n  );\n\n  let app;\n  let root;\n  if (__BROWSER__) {\n    root = document.createElement('div');\n    root.setAttribute('id', 'root');\n    if (document.body) {\n      document.body.appendChild(root);\n    }\n    app = new App(Root, el => render(el, root));\n  } else {\n    app = new App(Root);\n  }\n  app.register(HelmetPlugin);\n  app.middleware((ctx, next) => {\n    ctx.nonce = 'test-nonce';\n    return next();\n  });\n  const sim = getSimulator(app);\n  const ctx = await sim.render('/');\n\n  if (__NODE__) {\n    const fixtureFile = './src/__fixtures__/ssr1.html';\n    // Uncomment to regenerate fixture\n    // fs.writeFileSync(fixtureFile, ctx.body);\n    t.equal(ctx.body, fs.readFileSync(fixtureFile).toString());\n  } else if (__BROWSER__) {\n    // need to wait until next tick for dom changes\n    await new Promise(resolve => setTimeout(resolve, 10));\n    t.equal(document.title, 'My Title');\n    const baseEl = document.querySelector('base');\n    if (!baseEl) {\n      throw new Error('Could not find base element');\n    }\n    t.equal(baseEl.getAttribute('href'), 'http://mysite.com/');\n    const metaDescription = document.querySelector('meta[name=\"description\"]');\n    if (!metaDescription) {\n      throw new Error('Could not find meta description');\n    }\n    t.equal(metaDescription.getAttribute('content'), 'Helmet application');\n    if (document.body && root instanceof HTMLElement) {\n      document.body.removeChild(root);\n    }\n  }\n  t.end();\n});\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport React from 'react';\nimport App from 'fusion-react';\nimport {getSimulator} from 'fusion-test-utils';\nimport test from 'tape-cup';\nimport HelmetPlugin from '../index.js';\n\ntest('Non render request', async t => {\n  const app = new App(React.createElement('div'), el => el);\n  app.register(HelmetPlugin);\n  const sim = getSimulator(app);\n  const ctx = await sim.request('/');\n  t.equal(ctx.element, null, 'does not wrap ctx.element');\n  t.end();\n});\n\ntest('Render request with server side redirect', async t => {\n  const app = new App(React.createElement('div'), el => el);\n  app.register(HelmetPlugin);\n  app.middleware((ctx, next) => {\n    ctx.redirect('/test');\n    return next();\n  });\n  const sim = getSimulator(app);\n  await sim.render('/');\n  t.end();\n});\n"],"names":["keys","plugin","createPlugin","middleware","ctx","next","element","helmetContext","HelmetProvider","helmet","template","title","toString","replace","forEach","key","head","push","dangerouslySetHTML","serverPlugin","name","test","t","TestA","Helmet","Root","app","App","register","HelmetPlugin","nonce","sim","getSimulator","render","fixtureFile","equal","body","fs","readFileSync","end","React","createElement","el","request","redirect"],"mappings":"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"}
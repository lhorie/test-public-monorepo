{"version":3,"file":"node.js","sources":["../src/__tests__/flow.node.js","../src/ctx-enhancer.js","../src/tokens.js","../src/browser.js","../src/server.js","../src/index.js","../src/__tests__/index.node.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env node */\n\nimport execa from 'execa';\nimport test from 'tape-cup';\n\ntest('Flow tests', async t => {\n  // This test is currently failing in release verification due to monorepo construction.\n  // Quick fix to disable this running in CI.\n  if (process.env.BUILDKITE_PIPELINE_SLUG === 'fusion-release-verification') {\n    return t.end();\n  }\n  const failurePath = 'src/fixtures/failure';\n  const successPath = 'src/fixtures/success';\n  try {\n    await execa.shell(`flow check ${failurePath}`);\n    t.fail('Should fail flow check');\n  } catch (e) {\n    const {stdout} = e;\n    t.ok(stdout.includes('Found 1 error'));\n  }\n  await execa.shell(`flow check ${successPath}`);\n  t.end();\n});\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n\nimport {createStore} from 'redux';\nimport type {Store} from 'redux';\n\nimport type {Context} from 'fusion-core';\n\ntype CreateStoreType = typeof createStore;\ntype StoreWithContextType = Store<*, *, *> & {ctx: Context};\n\nexport default (ctx?: Context) => (createStore: CreateStoreType) => (\n  ...args: any\n) => {\n  const store: StoreWithContextType = {\n    ...createStore(...args),\n    ctx: ctx,\n  };\n  return store;\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Reducer, StoreEnhancer} from 'redux';\n\nimport {createToken} from 'fusion-core';\nimport type {Token} from 'fusion-core';\n\nimport type {GetInitialStateType, ReactReduxServiceType} from './types.js';\n\nexport const ReduxToken: Token<ReactReduxServiceType> = createToken(\n  'ReduxToken'\n);\nexport const ReducerToken: Token<Reducer<*, *>> = createToken('ReducerToken');\nexport const PreloadedStateToken: Token<Object> = createToken(\n  'PreloadedStateToken'\n);\nexport const EnhancerToken: Token<StoreEnhancer<*, *, *>> = createToken(\n  'EnhancerToken'\n);\nexport const GetInitialStateToken: Token<\n  GetInitialStateType<Object>\n> = createToken('GetInitialStateToken');\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\n/* globals __REDUX_DEVTOOLS_EXTENSION__ */\n\nimport React from 'react';\nimport {Provider} from 'react-redux';\nimport {compose, createStore} from 'redux';\n\nimport {createPlugin, unescape} from 'fusion-core';\nimport type {Context, FusionPlugin} from 'fusion-core';\n\nimport ctxEnhancer from './ctx-enhancer';\nimport {ReducerToken, PreloadedStateToken, EnhancerToken} from './tokens.js';\nimport type {\n  StoreWithContextType,\n  ReactReduxDepsType,\n  ReactReduxServiceType,\n} from './types.js';\n\nconst getPlugin = () => {\n  let storeCache = null;\n  return createPlugin({\n    deps: {\n      reducer: ReducerToken,\n      preloadedState: PreloadedStateToken.optional,\n      enhancer: EnhancerToken.optional,\n    },\n    provides({reducer, preloadedState, enhancer}) {\n      class Redux {\n        store: StoreWithContextType<*, *, *>;\n\n        constructor(ctx) {\n          if (storeCache) {\n            // $FlowFixMe\n            this.store = storeCache;\n          } else {\n            // We only use initialState for client-side hydration\n            // The real initial state should be derived from the reducer and the @@INIT action\n            if (!preloadedState) {\n              const stateElement = document.getElementById('__REDUX_STATE__');\n              if (stateElement) {\n                preloadedState = JSON.parse(unescape(stateElement.textContent));\n              }\n            }\n            const devTool =\n              __DEV__ &&\n              window.__REDUX_DEVTOOLS_EXTENSION__ &&\n              // $FlowFixMe\n              __REDUX_DEVTOOLS_EXTENSION__();\n            const enhancers = [enhancer, ctxEnhancer(ctx), devTool].filter(\n              Boolean\n            );\n            // $FlowFixMe\n            this.store = createStore(\n              reducer,\n              preloadedState,\n              // $FlowFixMe\n              compose(...enhancers)\n            );\n            storeCache = this.store;\n          }\n        }\n      }\n      return {\n        from: (ctx?: Context) => {\n          return new Redux(ctx);\n        },\n      };\n    },\n    middleware(_, redux) {\n      return (ctx, next) => {\n        const {store} = redux.from(ctx);\n        ctx.element = <Provider store={store}>{ctx.element}</Provider>;\n        return next();\n      };\n    },\n    cleanup: async () => {\n      storeCache = null;\n    },\n  });\n};\n\nexport default ((getPlugin: any): () => FusionPlugin<\n  ReactReduxDepsType,\n  ReactReduxServiceType\n>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport React from 'react';\nimport {compose, createStore} from 'redux';\nimport {Provider} from 'react-redux';\n\nimport {createPlugin, memoize, html} from 'fusion-core';\nimport type {FusionPlugin, Context} from 'fusion-core';\n\nimport ctxEnhancer from './ctx-enhancer';\nimport {\n  ReducerToken,\n  PreloadedStateToken,\n  EnhancerToken,\n  GetInitialStateToken,\n} from './tokens.js';\nimport type {\n  StoreWithContextType,\n  ReactReduxDepsType,\n  ReactReduxServiceType,\n} from './types.js';\n\nconst plugin =\n  __NODE__ &&\n  createPlugin({\n    deps: {\n      reducer: ReducerToken,\n      preloadedState: PreloadedStateToken.optional,\n      enhancer: EnhancerToken.optional,\n      getInitialState: GetInitialStateToken.optional,\n    },\n    provides({reducer, preloadedState, enhancer, getInitialState}) {\n      class Redux {\n        ctx: Context;\n        store: ?StoreWithContextType<*, *, *>;\n\n        constructor(ctx) {\n          // We only use initialState for client-side hydration\n          // The real initial state should be derived from the reducer and the @@INIT action\n          this.ctx = ctx;\n          this.store = null;\n        }\n        async initStore() {\n          if (this.store) {\n            return this.store;\n          }\n          if (getInitialState) {\n            preloadedState = Object.assign(\n              {},\n              preloadedState,\n              await getInitialState(this.ctx)\n            );\n          }\n          const enhancers = [enhancer, ctxEnhancer(this.ctx)].filter(Boolean);\n          // $FlowFixMe\n          this.store = createStore(\n            reducer,\n            preloadedState,\n            // $FlowFixMe\n            compose(...enhancers)\n          );\n          return this.store;\n        }\n      }\n      return {\n        from: memoize(ctx => new Redux(ctx)),\n      };\n    },\n    middleware(_, redux) {\n      return async (ctx, next) => {\n        if (!ctx.element) return next();\n        const store = await redux.from(ctx).initStore();\n        ctx.element = <Provider store={store}>{ctx.element}</Provider>;\n        await next();\n\n        const serialized = JSON.stringify(store.getState());\n        const script = html`\n          <script type=\"application/json\" id=\"__REDUX_STATE__\">\n            ${serialized}\n          </script>\n        `;\n        ctx.template.body.push(script);\n      };\n    },\n  });\n\nexport default ((plugin: any): FusionPlugin<\n  ReactReduxDepsType,\n  ReactReduxServiceType\n>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport browserPlugin from './browser';\nimport serverPlugin from './server';\n\nexport default (__NODE__ ? serverPlugin : browserPlugin());\n\nexport type {GetInitialStateType} from './types';\n\nexport {\n  ReduxToken,\n  ReducerToken,\n  PreloadedStateToken,\n  EnhancerToken,\n  GetInitialStateToken,\n} from './tokens';\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport tape from 'tape-cup';\nimport React from 'react';\nimport type {Reducer, StoreEnhancer} from 'redux';\n\nimport App, {consumeSanitizedHTML, createPlugin} from 'fusion-core';\nimport type {FusionPlugin} from 'fusion-core';\nimport {getSimulator, getService} from 'fusion-test-utils';\n\nimport Redux from '../index.js';\nimport {\n  EnhancerToken,\n  PreloadedStateToken,\n  ReducerToken,\n  GetInitialStateToken,\n  ReduxToken,\n} from '../tokens.js';\n\n/* Test fixtures */\nconst appCreator = (reducer, preloadedState, getInitialState, enhancer) => {\n  const app = new App('test', el => el);\n  if (reducer) {\n    app.register(ReducerToken, reducer);\n  }\n  if (preloadedState) {\n    app.register(PreloadedStateToken, preloadedState);\n  }\n  if (getInitialState) {\n    app.register(GetInitialStateToken, getInitialState);\n  }\n  if (enhancer) {\n    app.register(EnhancerToken, enhancer);\n  }\n  return () => app;\n};\n\ntape('interface', async t => {\n  const ctx = {memoized: new Map()};\n  const reducer = (state, action) => ({test: action.payload || 1});\n  const redux = getService(appCreator(reducer), Redux).from((ctx: any));\n\n  t.plan(2);\n  if (!redux.initStore) {\n    t.end();\n    return;\n  }\n  const store = await redux.initStore();\n\n  t.equals(store.getState().test, 1, 'state is accessible');\n  store.dispatch({type: 'CHANGE', payload: 2});\n  t.equals(store.getState().test, 2, 'state receives dispatch');\n  t.end();\n});\n\ntape('non-ssr routes', async t => {\n  const reducer = (state, action) => ({test: action.payload || 1});\n  const plugin = getService(appCreator(reducer), Redux);\n  let mockCtx = {\n    body: null,\n    memoized: new Map(),\n  };\n\n  t.plan(1);\n  if (!Redux.middleware) {\n    t.end();\n    return;\n  }\n\n  // $FlowFixMe\n  await Redux.middleware(null, plugin)((mockCtx: any), () => Promise.resolve());\n  t.notok(plugin.from((mockCtx: any)).store);\n  t.end();\n});\n\ntape('getInitialState', async t => {\n  const reducer = (state = {}, action) => ({\n    ...state,\n    test: action.payload || 1,\n  });\n  const mockCtx = {mock: true, memoized: new Map()};\n  const getInitialState: any = async ctx => {\n    t.equal(ctx, mockCtx);\n    return {hello: 'world'};\n  };\n  const preloadedState = {a: 'b'};\n  const redux = getService(\n    appCreator(reducer, preloadedState, getInitialState),\n    Redux\n  ).from((mockCtx: any));\n\n  t.plan(6);\n  if (!redux.initStore) {\n    t.end();\n    return;\n  }\n\n  const store = await redux.initStore();\n\n  t.equals(store.getState().test, 1, 'state is accessible');\n  t.equal(store.getState().hello, 'world');\n  t.equal(store.getState().a, 'b');\n  store.dispatch({type: 'CHANGE', payload: 2});\n  t.equals(store.getState().test, 2, 'state receives dispatch');\n  t.equal(\n    store,\n    await (redux.initStore && redux.initStore()),\n    'memoization works'\n  );\n  t.end();\n});\n\ntape('enhancers', async t => {\n  const mockCtx: any = {mock: true, memoized: new Map()};\n  const myEnhancer = createStore => (...args) => {\n    const store = createStore(...args);\n    // $FlowFixMe\n    t.equals(store.ctx, mockCtx, '[Enhancer] ctx provided by ctxEnhancer');\n    return store;\n  };\n  const reducer = s => s;\n  const redux = getService(\n    appCreator(reducer, null, null, myEnhancer),\n    Redux\n  ).from(mockCtx);\n\n  t.plan(2);\n  if (!redux.initStore) {\n    t.end();\n    return;\n  }\n\n  const store = await redux.initStore();\n  t.equals(store.ctx, mockCtx, '[Final store] ctx provided by ctxEnhancer');\n  t.end();\n});\n\nconst testEnhancer = async (\n  t: tape$Context,\n  enhancer: StoreEnhancer<*, *, *> | FusionPlugin<*, StoreEnhancer<*, *, *>>\n): Promise<void> => {\n  const app = new App('el', el => el);\n  const mockReducer: Reducer<*, *> = s => s;\n\n  app.register(EnhancerToken, enhancer);\n  app.register(ReducerToken, mockReducer);\n  app.register(ReduxToken, Redux);\n\n  const testPlugin = createPlugin({\n    deps: {\n      redux: ReduxToken,\n    },\n    middleware({redux}) {\n      return async (ctx, next) => {\n        const reduxScoped = redux.from(ctx);\n\n        if (!reduxScoped.initStore) {\n          t.fail();\n          t.end();\n          return;\n        }\n\n        const store = await reduxScoped.initStore();\n        // $FlowFixMe\n        t.equals(store.mock, true, '[Final store] ctx provided by ctxEnhancer');\n\n        return next();\n      };\n    },\n  });\n  app.register(testPlugin);\n\n  const simulator = getSimulator(app);\n  await simulator.render('/');\n};\n\ntape('enhancers - via app.register', async t => {\n  /* Enhancer function */\n  const myEnhancer: StoreEnhancer<*, *, *> = createStore => (...args) => {\n    const store = createStore(...args);\n    // $FlowFixMe\n    store.mock = true;\n    return store;\n  };\n  await testEnhancer(t, myEnhancer);\n\n  /* Enhancer plugin */\n  const myEnhancerPlugin: FusionPlugin<\n    *,\n    StoreEnhancer<*, *, *>\n  > = createPlugin({\n    provides() {\n      return myEnhancer;\n    },\n  });\n  await testEnhancer(t, myEnhancerPlugin);\n\n  t.end();\n});\n\ntape('serialization', async t => {\n  const reducer = (state, action) => ({\n    test: action.payload || 1,\n    xss: '</div>',\n  });\n  const element = React.createElement('div');\n  const ctx: any = {element, template: {body: []}, memoized: new Map()};\n  const Plugin = getService(appCreator(reducer), Redux);\n\n  t.plan(5);\n  if (!Redux.middleware) {\n    t.end();\n    return;\n  }\n\n  // $FlowFixMe\n  await Redux.middleware(null, Plugin)(ctx, () => Promise.resolve());\n\n  t.ok(Plugin.from(ctx).store);\n  t.notEquals(ctx.element, element, 'wraps provider');\n  t.equals(ctx.template.body.length, 1, 'pushes serialization to body');\n  // $FlowFixMe\n  t.equals(consumeSanitizedHTML(ctx.template.body[0]).match('test')[0], 'test');\n  t.equals(consumeSanitizedHTML(ctx.template.body[0]).match('</div>'), null);\n  t.end();\n});\n"],"names":["test","t","process","env","BUILDKITE_PIPELINE_SLUG","end","failurePath","successPath","execa","shell","fail","e","stdout","ok","includes","ctx","createStore","args","store","ReduxToken","createToken","ReducerToken","PreloadedStateToken","EnhancerToken","GetInitialStateToken","plugin","createPlugin","deps","reducer","preloadedState","optional","enhancer","getInitialState","provides","Redux","constructor","initStore","Object","assign","enhancers","ctxEnhancer","filter","Boolean","compose","from","memoize","middleware","_","redux","next","element","Provider","serialized","JSON","stringify","getState","script","html","template","body","push","serverPlugin","appCreator","app","App","el","register","tape","memoized","Map","state","action","payload","getService","plan","equals","dispatch","type","mockCtx","Promise","resolve","notok","mock","equal","hello","a","myEnhancer","s","testEnhancer","mockReducer","testPlugin","reduxScoped","simulator","getSimulator","render","myEnhancerPlugin","xss","React","createElement","Plugin","notEquals","length","consumeSanitizedHTML","match"],"mappings":";;;;;;;;;;;;;AAAA;;;;;;;;;AAUA,AAGAA,IAAI,CAAC,YAAD,EAAe,MAAMC,CAAN,IAAW;;;MAGxBC,OAAO,CAACC,GAAR,CAAYC,uBAAZ,KAAwC,6BAA5C,EAA2E;WAClEH,CAAC,CAACI,GAAF,EAAP;;;QAEIC,WAAW,GAAG,sBAApB;QACMC,WAAW,GAAG,sBAApB;;MACI;UACIC,KAAK,CAACC,KAAN,CAAa,cAAaH,WAAY,EAAtC,CAAN;IACAL,CAAC,CAACS,IAAF,CAAO,wBAAP;GAFF,CAGE,OAAOC,CAAP,EAAU;UACJ;MAACC;QAAUD,CAAjB;IACAV,CAAC,CAACY,EAAF,CAAKD,MAAM,CAACE,QAAP,CAAgB,eAAhB,CAAL;;;QAEIN,KAAK,CAACC,KAAN,CAAa,cAAaF,WAAY,EAAtC,CAAN;EACAN,CAAC,CAACI,GAAF;CAhBE,CAAJ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACHA,AAQA,mBAAgBU,GAAD,IAAmB;;;SAACC,WAAD,IAAkC;;;YAClE,GAAGC,IAD+D,KAE/D;;YACGC,KAA2B,6CAC5BF,WAAW,CAAC,GAAGC,IAAJ,CADiB;QAE/BF,GAAG,EAAEA;SAFP;;aAIOG,KAAP;KAPkE;GAAlC;CAAlC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACRA,AAKO,MAAMC,UAAwC,2BAAGC,eAAW,CACjE,YADiE,CAAd,CAA9C;AAGP,AAAO,MAAMC,YAAkC,2BAAGD,eAAW,CAAC,cAAD,CAAd,CAAxC;AACP,AAAO,MAAME,mBAAkC,2BAAGF,eAAW,CAC3D,qBAD2D,CAAd,CAAxC;AAGP,AAAO,MAAMG,aAA4C,2BAAGH,eAAW,CACrE,eADqE,CAAd,CAAlD;AAGP,AAAO,MAAMI,oBAEZ,2BAAGJ,eAAW,CAAC,sBAAD,CAAd,CAFM;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACdP;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACHA,AAoBA,MAAMK,MAAM,2BACV,+DACAC,gBAAY,CAAC;EACXC,IAA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"}
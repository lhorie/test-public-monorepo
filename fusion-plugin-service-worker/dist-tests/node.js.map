{"version":3,"file":"node.js","sources":["../src/browser.js","../src/tokens.js","../src/server.js","../src/handlers.js","../src/index.js","../src/__tests__/fixtures/swTemplate.js","../src/__tests__/index.node.js"],"sourcesContent":["// @flow\n\n/* global window */\n\nimport {createPlugin} from 'fusion-core';\nimport type {FusionPlugin} from 'fusion-core';\n\nexport default ((createPlugin({\n  middleware() {\n    return (ctx, next) => {\n      if ('serviceWorker' in window.navigator) {\n        window.addEventListener('load', function register() {\n          const sw = window.navigator.serviceWorker;\n          sw.register('/sw.js')\n            /* eslint-disable-next-line no-console */\n            .then(res => console.log('*** sw registered:', res))\n            /* eslint-disable-next-line no-console */\n            .catch(e => console.log('*** sw registration failed:', e));\n        });\n      }\n      return next();\n    };\n  },\n}): any): FusionPlugin<{}, void>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from 'fusion-core';\n\nimport type {ConfigTokenType} from './types.js';\n\nexport const SWTemplateFunctionToken: ConfigTokenType = createToken(\n  'SWTemplateFunctionToken'\n);\n","// @flow\n\n/* global */\n\nimport {createPlugin} from 'fusion-core';\nimport type {FusionPlugin} from 'fusion-core';\n\nimport {SWTemplateFunctionToken} from './tokens';\n\nfunction invokeTemplateFn(templateFn, resources) {\n  return templateFn(resources);\n}\n\nexport default ((__NODE__ &&\n  createPlugin({\n    deps: {\n      templateFn: SWTemplateFunctionToken,\n    },\n    middleware: ({templateFn}) => {\n      return async (ctx, next) => {\n        if (__NODE__) {\n          if (ctx.method === 'GET' && ctx.url === '/sw.js') {\n            const chunkUrls = Array.from(ctx.chunkUrlMap).map(value =>\n              value[1].get('es5')\n            );\n            try {\n              ctx.type = 'text/javascript';\n              ctx.set('Cache-Control', 'max-age=0');\n              ctx.body = invokeTemplateFn(templateFn, {\n                // TODO(#24): use correct values\n                precachePaths: chunkUrls,\n                cacheablePaths: chunkUrls,\n              });\n            } catch (e) {\n              // TODO(#25): do something maybe\n            }\n          }\n          return next();\n        }\n      };\n    },\n  }): any): FusionPlugin<{}, void>);\n","// @flow\n\n/* eslint-env serviceworker */\n/* globals location, URL, fetch,  */\n\nimport type {AssetInfo} from './types';\n\nconst cacheName = '0.0.0'; // we don't expect this to change\n\nexport default function getHandlers(assetInfo: AssetInfo) {\n  const {precachePaths, cacheablePaths} = assetInfo;\n  return {\n    onInstall: (event: InstallEvent) => {\n      self.skipWaiting();\n      event.waitUntil(\n        // remove old cache\n        caches\n          .open(cacheName)\n          .then(cache => {\n            return cache\n              .addAll(precachePaths)\n              .then(() =>\n                getOutdatedKeys(cache, cacheablePaths).then(outdatedKeys =>\n                  removeKeys(cache, outdatedKeys)\n                )\n              );\n          })\n          .catch(e => {\n            throw new Error(`sw: error updating cache ${cacheName}: ${e}`);\n          })\n      );\n    },\n    onFetch: (event: FetchEvent) => {\n      const HTML_TTL = 1 * 24 * 60 * 60 * 1001; // 1 day\n      const expectsHtml = requestExpectsHtml(event.request);\n      if (\n        !expectsHtml &&\n        !cacheablePaths.includes(new URL(event.request.url).pathname)\n      ) {\n        // bypass service worker, use network\n        return;\n      }\n      const p = caches.match(event.request).then(cachedResponse => {\n        if (cachedResponse) {\n          if (expectsHtml) {\n            const responseCreated = new Date(\n              cachedResponse.headers.get('date') || 0\n            ).valueOf();\n            if (Date.now() - responseCreated > HTML_TTL) {\n              // html expired: use the cache, but refresh cache for next time\n              fetchNCache(event.request, expectsHtml);\n            }\n          }\n          return cachedResponse;\n        }\n        return fetchNCache(event.request, expectsHtml);\n      });\n      event.respondWith(p);\n      event.waitUntil(p);\n    },\n  };\n}\n\nfunction getOutdatedKeys(cache, cacheablePaths) {\n  return cache.keys().then(requests =>\n    requests.filter(request => {\n      return !cacheablePaths.find(key => {\n        return location.origin + String(key) === request.url;\n      });\n    })\n  );\n}\n\nfunction removeKeys(cache, keys) {\n  return Promise.all(keys.map(key => cache.delete(key)));\n}\n\nfunction fetchNCache(request, expectsHtml) {\n  return fetch(request).then(resp => {\n    if (resp.status !== 200) {\n      return Promise.resolve(resp);\n    }\n    const clonedResponse = resp.clone();\n    caches.open(cacheName).then(cache => {\n      if (expectsHtml) {\n        // check we got html before caching\n        if (!responseIsHtml(clonedResponse)) {\n          return Promise.resolve(resp);\n        }\n      }\n      cache.put(request.url, clonedResponse);\n    });\n    return Promise.resolve(resp);\n  });\n}\n\nfunction requestExpectsHtml(request) {\n  if (!request || !request.headers) {\n    return false;\n  }\n  const acceptHeader = request.headers.get('Accept');\n  return acceptHeader && acceptHeader.indexOf('html') > -1;\n}\n\nfunction responseIsHtml(response) {\n  if (!response || !response.headers) {\n    return false;\n  }\n  const contentType = response.headers.get('content-type');\n  return contentType && contentType.indexOf('html') > -1;\n}\n","// @flow\n\nimport browserPlugin from './browser';\nimport serverPlugin from './server';\nimport getHandlers from './handlers';\nimport {SWTemplateFunctionToken} from './tokens';\n\nexport default (__NODE__ ? serverPlugin : browserPlugin);\nexport {getHandlers, SWTemplateFunctionToken};\n","// @flow\n/* globals,  */\n\nimport type {AssetInfo} from '../../types';\n\nexport default (params: AssetInfo) => {\n  // simplified sw for testing\n  return `var sw = (assetInfo: AssetInfo) => {\n    return /* test SW */\n    var cacheName = '0.0.0';\n    var precachePaths = assetInfo.precachePaths;\n    console.log('1');\n    event => {\n      self.skipWaiting();\n      event.waitUntil(\n        caches\n          .open(cacheName)\n          .then(cache => {\n            return cache.addAll(precachePaths);\n          })\n          .catch(e => {\n            throw new Error();\n          })\n      );\n    };;\n  };\n  return sw(${JSON.stringify(params)})`;\n};\n","// @flow\nimport test from 'tape-cup';\nimport {getSimulator} from 'fusion-test-utils';\nimport App from 'fusion-core';\nimport ServiceWorker from '../index';\nimport {SWTemplateFunctionToken} from '../tokens';\nimport swTemplateFunction from './fixtures/swTemplate.js';\n\ntest('/health request', async t => {\n  const app = new App('el', el => el);\n  app.register(SWTemplateFunctionToken, swTemplateFunction);\n  app.register(ServiceWorker);\n  const sim = getSimulator(app);\n  // Basic /health request\n  const ctx_1 = await sim.request('/sw.js');\n  t.equal(ctx_1.status, 200, 'sends 200 status on sw request');\n  t.ok(\n    ctx_1.body\n      .replace(/\\n/g, '')\n      .startsWith(`var sw = (assetInfo: AssetInfo) => {`),\n    'sends correct response'\n  );\n  t.end();\n\n  await app.cleanup();\n});\n"],"names":["createPlugin","middleware","ctx","next","window","navigator","addEventListener","register","sw","serviceWorker","then","res","console","log","catch","e","SWTemplateFunctionToken","createToken","invokeTemplateFn","templateFn","resources","deps","method","url","chunkUrls","Array","from","chunkUrlMap","map","value","get","type","set","body","precachePaths","cacheablePaths","cacheName","serverPlugin","params","JSON","stringify","test","t","app","App","el","swTemplateFunction","ServiceWorker","sim","getSimulator","ctx_1","request","equal","status","ok","replace","startsWith","end","cleanup"],"mappings":"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;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACNA,MAAMiC,SAAS,2BAAG,OAAH,CAAf;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACLA,AAKA,+CAA2BC,YAAX,CAAhB;;ACNA;AAIA,0BAAgBC,MAAD,IAAuB;;SAE5B;;;;;;;;;;;;;;;;;;;cAmBIC,IAAI,CAACC,SAAL,CAAeF,MAAf,CAAuB,GAnBnC;CAFF;;ACGAG,IAAI,CAAC,iBAAD,EAAoB,MAAMC,CAAN,IAAW;QAC3BC,GAAG,GAAG,IAAIC,YAAJ,CAAQ,IAAR,EAAcC,EAAE,IAAIA,EAApB,CAAZ;EACAF,GAAG,CAACpC,QAAJ,CAAaS,uBAAb,EAAsC8B,kBAAtC;EACAH,GAAG,CAACpC,QAAJ,CAAawC,aAAb;QACMC,GAAG,GAAGC,4BAAY,CAACN,GAAD,CAAxB,CAJiC;;QAM3BO,KAAK,GAAG,MAAMF,GAAG,CAACG,OAAJ,CAAY,QAAZ,CAApB;EACAT,CAAC,CAACU,KAAF,CAAQF,KAAK,CAACG,MAAd,EAAsB,GAAtB,EAA2B,gCAA3B;EACAX,CAAC,CAACY,EAAF,CACEJ,KAAK,CAACjB,IAAN,CACGsB,OADH,CACW,KADX,EACkB,EADlB,EAEGC,UAFH,CAEe,sCAFf,CADF,EAIE,wBAJF;EAMAd,CAAC,CAACe,GAAF;QAEMd,GAAG,CAACe,OAAJ,EAAN;CAhBE,CAAJ"}
{"version":3,"file":"node.js","sources":["../src/__tests__/fixtures/static/font-config.js","../src/__tests__/fixtures/expected.js","../src/generate-fallback-map.js","../src/generate-font-faces.js","../src/generate-preload-links.js","../src/__tests__/index.js","../src/font-loader.js","../src/with-font-loading.js","../src/provider.js","../src/preload-session.js","../src/tokens.js","../src/plugin.js","../src/__tests__/plugin.node.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {FontType} from '../../../types.js';\n\nexport const preloadDepth: number = 1;\nexport const fonts: {[string]: FontType} = {\n  'Lato-Regular': {\n    urls: {\n      woff: 'Lato-Regular.woff',\n      woff2: 'Lato-Regular.woff2',\n    },\n    fallback: {\n      name: 'Helvetica',\n    },\n  },\n  'Lato-Bold': {\n    urls: {\n      woff: 'Lato-Bold.woff',\n      woff2: 'Lato-Bold.woff2',\n    },\n    fallback: {\n      name: 'Lato-Regular',\n      styles: {\n        'font-weight': 'bold',\n      },\n    },\n  },\n  'Lato-Thin': {\n    urls: {\n      woff: 'Lato-Thin.woff',\n      woff2: 'Lato-Thin.woff2',\n    },\n    fallback: {\n      name: 'Lato-Regular',\n      styles: {\n        'font-weight': '100',\n      },\n    },\n  },\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport const fallbackLookup = {\n  depth0: {},\n  depth1: {\n    'Lato-Bold': {\n      name: 'Lato-Regular',\n      styles: {'font-weight': 'bold'},\n    },\n    'Lato-Thin': {\n      name: 'Lato-Regular',\n      styles: {'font-weight': '100'},\n    },\n  },\n  depth2: {\n    'Lato-Regular': {\n      name: 'Helvetica',\n    },\n    'Lato-Bold': {\n      name: 'Helvetica',\n    },\n    'Lato-Thin': {\n      name: 'Helvetica',\n    },\n  },\n};\n\nexport const fontFaces =\n  '\\n@font-face {font-family: \"Lato-Regular\"; font-display: \\'fallback\\'; src: url(\"Lato-Regular.woff\") format(\"woff\")\\n,url(\"Lato-Regular.woff2\") format(\"woff2\")\\n;}\\n@font-face {font-family: \"Lato-Bold\"; font-display: \\'fallback\\'; src: url(\"Lato-Bold.woff\") format(\"woff\")\\n,url(\"Lato-Bold.woff2\") format(\"woff2\")\\n;}\\n@font-face {font-family: \"Lato-Thin\"; font-display: \\'fallback\\'; src: url(\"Lato-Thin.woff\") format(\"woff\")\\n,url(\"Lato-Thin.woff2\") format(\"woff2\")\\n;}';\n\nexport const preloadLinks =\n  '\\n<link rel=\"preload\" href=\"Lato-Regular.woff2\" as=\"font\" type=\"font/woff2\" crossorigin>';\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport default function generateFallbackMap(fonts: {}, preloadDepth: number) {\n  // map of font name to array of possible fallbacks (name and style offsets) (closest match first)\n  const fallbackCandidateLookup = {};\n  // keys are fonts that depth strategy suggests we should preload, values are always true\n  const preloadableFallbacks = {};\n  // keys are font names, values are objects with properties for fallback name and style offsets\n  const fallbackLookup = {};\n\n  // FIRST TRAVERSAL: gather set of possible fallbacks per font and\n  // the list of all fonts our depth strategy suggests we should preload\n  Object.keys(fonts).forEach(fontName => {\n    let depth = 0;\n    let nextFallback = {name: fontName};\n    fallbackCandidateLookup[fontName] = [nextFallback];\n    while (preloadDepth > depth++) {\n      const nextFont = fonts[nextFallback && nextFallback.name];\n      nextFallback = nextFont && nextFont.fallback;\n      if (!nextFallback) {\n        // possibly reached system font\n        return;\n      }\n      fallbackCandidateLookup[fontName].push(nextFallback);\n    }\n    preloadableFallbacks[nextFallback.name] = true;\n  });\n  // SECOND TRAVERSAL: for each font select the closest fallback font that we planned to preloaded\n  Object.keys(fonts).forEach(fontName => {\n    // if font itself is preloadable then no fallback required\n    if (!preloadableFallbacks[fontName]) {\n      // otherwise use the first preloadable fallback\n      const fallback = fallbackCandidateLookup[fontName].find(\n        fallback => preloadableFallbacks[fallback.name]\n      );\n      fallbackLookup[fontName] = fallback;\n    }\n  });\n\n  return fallbackLookup;\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport default function generateFontFaces(fontDictionary: {}) {\n  const faces = [];\n  Object.keys(fontDictionary).forEach(fontName => {\n    const font = fontDictionary[fontName];\n    if (font) {\n      faces.push(\n        `@font-face {font-family: \"${fontName}\"; font-display: 'fallback'; src: ${String(\n          asFontFaceSrc(font.urls)\n        )};}`\n      );\n    }\n  });\n  return '\\n' + faces.join('\\n');\n}\n\nfunction asFontFaceSrc(urls) {\n  // `urls` is a dictionary of font types (woff, woff2 etc) to url string\n  return Object.keys(urls).map(\n    type => `url(\"${urls[type]}\") format(\"${type}\")\\n`\n  );\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nexport default function generatePreloadLinks(\n  fontNames: {},\n  fontDictionary: {}\n) {\n  const links = [];\n  Object.keys(fontNames).forEach(fontName => {\n    const font = fontDictionary[fontName];\n    if (font) {\n      // We can't detect woff2 support on the server, but rel=prelaod\n      // is only supported by browsers that support woff2.\n      // Others will fail silently and pick up the font a little later\n      // via the style\n      links.push(\n        `\\n<link rel=\"preload\" href=\"${\n          font.urls.woff2\n        }\" as=\"font\" type=\"font/woff2\" crossorigin>`\n      );\n    }\n  });\n  return links.join('\\n');\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport tape from 'tape-cup';\n\nimport {fonts as mockFonts} from './fixtures/static/font-config';\nimport {\n  fallbackLookup as expectedFallbackLookup,\n  fontFaces as expectedFontFaces,\n  preloadLinks as expectedPreloadLinks,\n} from './fixtures/expected';\n\nimport generateFallbackMap from '../generate-fallback-map';\nimport generateFontFaces from '../generate-font-faces';\nimport generatePreloadLinks from '../generate-preload-links';\n\ntape('generateFallbackMap', t => {\n  t.equal(\n    typeof generateFallbackMap,\n    'function',\n    'exports a generateFallbackMap function'\n  );\n  t.deepEqual(generateFallbackMap(mockFonts, 0), expectedFallbackLookup.depth0);\n  t.deepEqual(generateFallbackMap(mockFonts, 1), expectedFallbackLookup.depth1);\n  t.deepEqual(generateFallbackMap(mockFonts, 2), expectedFallbackLookup.depth2);\n  t.end();\n});\n\ntape('generateFontFaces', t => {\n  t.equal(\n    typeof generateFontFaces,\n    'function',\n    'exports a generateFontFaces function'\n  );\n  t.equal(generateFontFaces(mockFonts), expectedFontFaces);\n  t.end();\n});\n\ntape('generatePreloadLinks', t => {\n  t.equal(\n    typeof generatePreloadLinks,\n    'function',\n    'exports a generatePreloadLinks function'\n  );\n  t.equal(\n    generatePreloadLinks({'Lato-Regular': true}, mockFonts),\n    expectedPreloadLinks\n  );\n  t.end();\n});\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/**\n * Polyfill loosely based on zenfonts\n * https://github.com/zengabor/zenfonts/\n * Copyright (c) 2015 Gabor Lenard\n */\n\n/* global document */\n\nconst testFonts = ['sans-serif', 'serif', 'monospace'];\n// TODO(#3): allow override\nconst testText = 'π+[.—_]imW12/?';\n// how long to wait for load before switching style to true font anyway\nconst timeout = 60000;\n\nexport default function(font: string) {\n  if (__BROWSER__ && document) {\n    // $FlowFixMe\n    return document.fonts && typeof document.fonts.load === 'function'\n      ? document.fonts.load(`1em ${font}`) // native API requires size\n      : loadFontPolyfill(font);\n  }\n}\n\nfunction loadFontPolyfill(font): Promise<void> {\n  const testDivs = createTestDivs();\n  // $FlowFixMe\n  testDivs.forEach(div => (div.style.fontFamily = `${font}, ${div.testFont}`));\n  const waitUntil = Date.now() + timeout;\n  return new Promise(resolve => {\n    (function monitorWidth(delay) {\n      setTimeout(function() {\n        if (Date.now() >= waitUntil || hasFontLoaded(testDivs)) {\n          resolve();\n          cleanup(testDivs);\n        } else {\n          monitorWidth(Math.max(delay * 1.5, 500));\n        }\n      }, delay);\n    })(10);\n  });\n}\n\nfunction hasFontLoaded(testDivs) {\n  // Test whether n elements that were originally diverse system fonts are now all equal widths\n  return Boolean(\n    testDivs\n      .map(div => div.offsetWidth)\n      .reduce((width1, width2) => (width1 === width2 ? width1 : NaN))\n  );\n}\n\nfunction cleanup(testDivs) {\n  testDivs.forEach(div => {\n    const p = div.parentNode;\n    if (p) {\n      p.removeChild(div);\n    }\n    return true;\n  });\n}\n\nfunction createTestDivs() {\n  return testFonts.map((testFont, i) => {\n    const div = document.createElement('div');\n    // $FlowFixMe\n    div.testFont = testFont;\n    div.style.cssText = `position:absolute;top:-999px;left:${-9999 +\n      i * 100}px;visibility:hidden;\n  white-space:nowrap;font-size:20em;font-family:${testFont}`;\n    div.appendChild(document.createTextNode(testText));\n    if (document && document.body) {\n      document.body.appendChild(div);\n    }\n    return div;\n  });\n}\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport * as React from 'react';\nimport PropTypes from 'prop-types';\n\nimport loadFont from './font-loader';\n\n/*\nReturns a React HOC\n1) starts loading real font and passes fallback font and faux styling to wrappedComponent as props.$fontStyles\n2) when font load completes passes real font to wrappedComponent as props.$fontStyles\n\nUsage:\nwithFontLoading(fontName)(wrappedComponent)\n\nfontProps is hash of font property names to required font names\ne.g. (with styletron)\nwithFontLoading('Lato-Bold')(styled('div', props => props.$fontStyles));\n\nAll requested fonts should be defined in src/fonts/fontConfig.js\n*/\n\nconst withFontLoading = (fontName: string) => {\n  return (\n    OriginalComponent: React.ComponentType<*>\n  ): React.ComponentType<*> => {\n    class WithFontLoading extends React.Component<*> {\n      props: *;\n      context: *;\n      state: *;\n\n      constructor(props: any, context: any) {\n        super(props, context);\n        const {fallbackName, styles} = this.context.getFontDetails(fontName);\n        if (fallbackName) {\n          // switch to fallback name and apply styles to trigger faux font rendition\n          this.state = {$fontStyles: {fontFamily: fallbackName, ...styles}};\n        } else {\n          // no need to do the fallback dance\n          this.state = {$fontStyles: {fontFamily: fontName}};\n        }\n      }\n\n      componentDidMount() {\n        if (this.state.$fontStyles.fontFamily !== fontName) {\n          // $FlowFixMe\n          loadFont(`${fontName}`).then(() => {\n            // $FlowFixMe\n            this.setState({$fontStyles: {fontFamily: fontName}});\n          });\n        }\n      }\n\n      render() {\n        return <OriginalComponent {...{...this.state, ...this.props}} />;\n      }\n    }\n\n    WithFontLoading.contextTypes = {\n      getFontDetails: PropTypes.func,\n    };\n    return WithFontLoading;\n  };\n};\n\nexport default withFontLoading;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport React, {Component} from 'react';\nimport PropTypes from 'prop-types';\n\nexport default class FontProvider extends Component<*, *> {\n  constructor(props: *, context: *) {\n    super(props, context);\n    this.getFontDetails = props.getFontDetails;\n  }\n\n  getFontDetails: {};\n\n  getChildContext() {\n    return {\n      getFontDetails: this.props.getFontDetails,\n    };\n  }\n  render() {\n    return React.Children.only(this.props.children);\n  }\n}\n\nFontProvider.propTypes = {\n  getFontDetails: PropTypes.func.isRequired,\n  children: PropTypes.element.isRequired,\n};\nFontProvider.childContextTypes = {\n  getFontDetails: PropTypes.func.isRequired,\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\ntype FallbackLookup = {\n  [string]: {\n    name: string,\n    styles: mixed,\n  },\n};\n\nclass PreloadSession {\n  fontsToPreload: {[string]: boolean};\n  fallbackLookup: FallbackLookup;\n\n  constructor(fallbackLookup: FallbackLookup) {\n    // keys are the actual fonts to preload (based on usage on the page), values are always true\n    this.fontsToPreload = {};\n    this.fallbackLookup = fallbackLookup;\n  }\n\n  getFontDetails = (name: string) => {\n    const {name: fallbackName, styles = {}} = this.fallbackLookup[name] || {};\n    const result = {\n      name,\n      fallbackName,\n      styles,\n    };\n    if (__NODE__) {\n      // preload fallback, or if font has no fallback preload font itself\n      this.fontsToPreload[fallbackName || name] = true;\n    }\n    return result;\n  };\n}\n\nexport default PreloadSession;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from 'fusion-core';\n\nimport type {ConfigTokenType, PluginTokenType} from './types.js';\n\nexport const FontLoaderReactToken: PluginTokenType = createToken(\n  'FontLoaderReactToken'\n);\n\nexport const FontLoaderReactConfigToken: ConfigTokenType = createToken(\n  'FontLoaderReactConfigToken'\n);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env node */\n\nimport React from 'react';\n\nimport {createPlugin, html, dangerouslySetHTML} from 'fusion-core';\n\nimport FontProvider from './provider';\nimport PreloadSession from './preload-session';\nimport generateFallbackMap from './generate-fallback-map';\nimport generatePreloadLinks from './generate-preload-links';\nimport generateFontFaces from './generate-font-faces';\nimport {FontLoaderReactConfigToken as ConfigToken} from './tokens';\nimport type {PluginType} from './types.js';\n\nconst plugin = createPlugin({\n  deps: {\n    config: ConfigToken,\n  },\n  middleware: ({config}) => {\n    const {fonts, preloadDepth} = config;\n    const fallbackLookup = generateFallbackMap(fonts, preloadDepth);\n    const preloadSession = new PreloadSession(fallbackLookup);\n\n    return (ctx, next) => {\n      if (ctx.element) {\n        ctx.element = (\n          <FontProvider getFontDetails={preloadSession.getFontDetails}>\n            {ctx.element}\n          </FontProvider>\n        );\n        return next().then(() => {\n          if (__NODE__) {\n            ctx.template.head.push(html`<style>`);\n            ctx.template.head.push(\n              dangerouslySetHTML(generateFontFaces(fonts))\n            );\n            ctx.template.head.push(html`</style>`);\n            ctx.template.head.push(\n              dangerouslySetHTML(\n                generatePreloadLinks(preloadSession.fontsToPreload, fonts)\n              )\n            );\n          }\n        });\n      } else {\n        return next();\n      }\n    };\n  },\n});\nexport default (plugin: PluginType);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport tape from 'tape-cup';\n\nimport App from 'fusion-core';\nimport {getSimulator} from 'fusion-test-utils';\n\nimport {\n  fonts as mockFonts,\n  preloadDepth as mockPreloadDepth,\n} from './fixtures/static/font-config';\n\nimport FontLoaderReactPlugin from '../index';\nimport {FontLoaderReactToken, FontLoaderReactConfigToken} from '../tokens';\n\ntape('exported as expected', t => {\n  t.ok(FontLoaderReactPlugin, 'plugin defined as expected');\n  t.equal(typeof FontLoaderReactPlugin, 'object', 'plugin is an object');\n  t.end();\n});\n\ntape('plugin - middleware modifies head as expected', t => {\n  const mockConfig = {\n    fonts: mockFonts,\n    preloadDepth: mockPreloadDepth,\n  };\n\n  const app = new App('content', el => el);\n  app.middleware(async (ctx, next) => {\n    await next();\n    t.true(ctx.template.head.length > 0, 'head was modified by plugin');\n  });\n  app.register(FontLoaderReactToken, FontLoaderReactPlugin);\n  app.register(FontLoaderReactConfigToken, mockConfig);\n  app.middleware((ctx, next) => {\n    ctx.body = {\n      head: [],\n    };\n    return next();\n  });\n\n  getSimulator(app).render('/');\n\n  t.end();\n});\n"],"names":["preloadDepth","fonts","urls","woff","woff2","fallback","name","styles","fallbackLookup","depth0","depth1","depth2","fontFaces","preloadLinks","generateFallbackMap","fallbackCandidateLookup","preloadableFallbacks","Object","keys","forEach","fontName","depth","nextFallback","nextFont","push","find","generateFontFaces","fontDictionary","faces","font","String","asFontFaceSrc","join","map","type","generatePreloadLinks","fontNames","links","tape","t","equal","deepEqual","mockFonts","expectedFallbackLookup","end","expectedFontFaces","expectedPreloadLinks","testFonts","testText","timeout","FontProvider","Component","constructor","props","context","getFontDetails","getChildContext","render","React","Children","only","children","propTypes","PropTypes","func","isRequired","element","childContextTypes","PreloadSession","fallbackName","result","fontsToPreload","FontLoaderReactToken","createToken","FontLoaderReactConfigToken","plugin","createPlugin","deps","config","ConfigToken","middleware","preloadSession","ctx","next","then","template","head","html","dangerouslySetHTML","ok","FontLoaderReactPlugin","mockConfig","mockPreloadDepth","app","App","el","true","length","register","body","getSimulator"],"mappings":"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"}